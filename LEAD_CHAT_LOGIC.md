# 📋 ЛОГИКА ЛИД-ЧАТОВ (endPointInTab == 'lead')

## 🎯 Краткое описание

В лид-чатах реализована специальная логика отображения сообщений на основе типа отправителя (`sender.type`), потому что несколько менеджеров могут одновременно отвечать одному лиду.

---

## 📊 Структура данных с бэкенда

### Пример JSON ответа для лид-чата:

```json
{
  "result": {
    "id": 4993,
    "type": "lead",
    "chatUsers": [
      {
        "type": "lead",
        "participant": {
          "id": 4387,
          "name": "sh.isfara"
        }
      },
      {
        "type": "user",
        "participant": {
          "id": 7,
          "name": "Икром",
          "full_name": "Икром Ашуралиев"
        }
      },
      {
        "type": "user",
        "participant": {
          "id": 1,
          "name": "Махмуджон",
          "full_name": "Махмуджон Ахмедов"
        }
      }
    ]
  }
}
```

### Пример сообщения:

```json
{
  "id": 123,
  "text": "Здравствуйте!",
  "sender": {
    "id": 7,
    "name": "Икром",
    "type": "user"  // ← ЭТО КЛЮЧЕВОЕ ПОЛЕ!
  },
  "chat": {
    "type": "lead"
  }
}
```

---

## 🔄 Логика определения `isMyMessage`

### ✅ ДЛЯ ЛИД-ЧАТОВ (endPointInTab == 'lead'):

```
IF sender.type == "user" THEN
  → isMyMessage = TRUE
  → Показываем СПРАВА (наша сторона)
  → Имя менеджера отображается над сообщением
  
ELSE IF sender.type == "lead" THEN
  → isMyMessage = FALSE
  → Показываем СЛЕВА (сторона клиента)
  → Имя лида отображается над сообщением
```

### Визуальное представление:

```
┌─────────────────────────────────────────────────┐
│  ЛИД-ЧАТ: sh.isfara                             │
├─────────────────────────────────────────────────┤
│                                                 │
│  👤 sh.isfara (type: lead)                      │
│  ┌─────────────────────┐                        │
│  │ Здравствуйте! Хочу  │ ← СЛЕВА (лид)          │
│  │ узнать о ваших      │                        │
│  │ услугах             │                        │
│  └─────────────────────┘                        │
│                                                 │
│                      👤 Икром (type: user)      │
│                      ┌─────────────────────┐    │
│            СПРАВА → │ Добрый день! Конечно│    │
│         (менеджер)   │ помогу!             │    │
│                      └─────────────────────┘    │
│                                                 │
│                      👤 Махмуджон (type: user)  │
│                      ┌─────────────────────┐    │
│            СПРАВА → │ Могу предложить наши│    │
│         (менеджер)   │ лучшие условия!     │    │
│                      └─────────────────────┘    │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 💻 Реализация в коде

### 1. **Модель `Message.fromJson()` (lib/models/chats_model.dart)**

```dart
// Проверяем тип чата
final bool isLeadChat = json['chat']['type'] == 'lead';

if (isLeadChat && json['sender']['type'] != null) {
  final senderType = json['sender']['type'];
  
  if (senderType == 'user') {
    isMyMessage = true;   // Менеджер → справа
  } else if (senderType == 'lead') {
    isMyMessage = false;  // Лид → слева
  }
} else {
  // Для корпоративных чатов и задач
  isMyMessage = json['is_my_message'];
}
```

### 2. **Сокет `chat.message` (lib/screens/chats/chat_sms_screen.dart)**

```dart
final bool isLeadChat = widget.endPointInTab == 'lead';

if (isLeadChat) {
  if (senderType == 'user') {
    isMyMessage = true;   // Менеджер → справа
  } else if (senderType == 'lead') {
    isMyMessage = false;  // Лид → слева
  }
} else {
  // Для корпоративных/задач - проверяем по ID
  isMyMessage = (UUID == senderId);
}
```

### 3. **Сокет `chat.updated` (2 места)**

Аналогичная логика применяется в двух местах обработки `chat.updated`.

---

## 🎨 Отображение имён отправителей

### Логика в виджетах (MessageBubble, ImageMessageBubble, FileMessageBubble, VoiceMessageBubble):

```dart
// В лид-чатах: показываем имя для ОБЕИХ сторон
// В задачах/корпоративных: только для собеседника
if (isLeadChat || !isSender) {
  Text(senderName, ...)
}
```

---

## 📝 Примеры логирования

При работе приложения в консоли будут отображаться детальные логи:

### Для начальной загрузки:
```
🎯 [LEAD CHAT] Message.fromJson: sender.type=user (менеджер: Икром) → isMyMessage=TRUE (справа)
🎯 [LEAD CHAT] Message.fromJson: sender.type=lead (клиент: sh.isfara) → isMyMessage=FALSE (слева)
```

### Для сокетов:
```
╔═══════════════════════════════════════════════════════╗
║  📨 LEAD CHAT - Обработка входящего сообщения через сокет  ║
╠═══════════════════════════════════════════════════════╣
║  Отправитель: Икром (ID: 7)
║  Тип отправителя: user
║  ✅ РЕЗУЛЬТАТ: sender.type = "user" (МЕНЕДЖЕР)
║  → Показываем СПРАВА (наша сторона)
║  → isMyMessage = TRUE
║  → Имя отображается: ДА (над сообщением)
╚═══════════════════════════════════════════════════════╝
```

---

## ✅ Проверочный список

- [x] **Логика в `Message.fromJson()`** - определяет `isMyMessage` по `sender.type` для лид-чатов
- [x] **Логика в сокете `chat.message`** - применяется только для `endPointInTab == 'lead'`
- [x] **Логика в сокете `chat.updated`** (2 места) - применяется только для `endPointInTab == 'lead'`
- [x] **Отображение имён** - в лид-чатах имя показывается для обеих сторон
- [x] **Корпоративные чаты и задачи** - используют стандартную логику по ID

---

## 🚀 Результат

### ✅ В лид-чатах (endPointInTab == 'lead'):
- `sender.type == 'user'` → показывается **СПРАВА** (наша сторона, менеджер)
- `sender.type == 'lead'` → показывается **СЛЕВА** (сторона лида)
- Имя отправителя показывается **для обеих сторон**
- Несколько менеджеров могут отвечать одному лиду

### ✅ В корпоративных чатах и задачах:
- Сообщения отображаются на **своих местах** (по ID отправителя)
- Имя показывается **только для собеседника**
- Стандартная логика работает как раньше

---

## 📞 Контакты для вопросов

Если возникнут вопросы или нужны доработки, обращайтесь к разработчику.

**Дата создания:** 03.01.2026
**Версия:** 1.0

